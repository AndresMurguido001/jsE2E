#! /usr/local/bin/bash

#Import the utility functions and data. This is done so it's loaded relative to the path of the script as opposed to whatever the CWD is
dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source $dir/util

#TODO add check for bash version since this program requires bash 4 for the associative arrays
ORDER_URL="$API_URL/order/create"

PRODUCT=${PRODUCTS[$1]};

if [[ -z "$4" || "$4" == 'passportcenter' ]]; #If the 4th parameter is empty or is passportcenter
then
    OPTION=${OPTIONSPC[$2]};
    SOURCE='passportcenter';
else #Right now you could just pass anything as the second parameter and the source will be set to passportrenewal lol
    OPTION=${OPTIONSPR[$2]};
    SOURCE='passportrenewal';
fi

EMAIL="$([ $3 ] && echo $3 || echo "$(random_email)")"

echo "Creating a $2 $1 on $SOURCE under the email $EMAIL"

api_call "$ORDER_URL" '{"source":"'"$SOURCE"'","itinerary":{"destinations":[{"country":null,"dates":{"startDate":null,"endDate":null}}],"travelers":{"adults":1,"children":0}},"travelers":[{"info":{"first_name":"'$FIRSTNAME'","last_name":"'$LASTNAME'","citizenship":null,"residency":null,"date_of_birth":"10/10/1989"},"products":[{"uuid":"'"$PRODUCT"'","option_uuid":"'"$OPTION"'","outbound_speed":"usps_priority_overnight","option_label":"Standard","product_label":"Passport Renewal","service_type":"standard_service","cost":149,"addons":[]}]}],"user_profile":{"first_name":"'$FIRSTNAME'","last_name":"'$LASTNAME'","email":"'"$EMAIL"'","phones":[{"type":"mobile","friendly_name":"Mobile Number","country":"US","value":"3456785432","disabled":true,"required":true,"hint":"Well use this number to send SMS notifications."},{"type":"landline","friendly_name":"Home or Office Number","country":"US","value":""}],"country":"US","company_name":null,"addresses":[{"type":"billing","address_1":"123","address_2":"","city":"Miami","state":"FL","country":"US","postal_code":"33133"},{"type":"shipping","address_1":"123","address_2":"","city":"Miami","state":"FL","country":"US","postal_code":"33133"}]},"gw_tracker":{"referer":"direct","query_string":""}, "merchant": "sandbox", "payment_token": "tok_visa"}'

echo "Changing user's password to: password"

CHANGE_PASSWORD_QUERY="UPDATE users SET password = '\$2y\$10\$D0C7hvq5m5eK.ccKTlIi4.KmrJL7ULj5.SxnGdwv/d/RIWLYqKV4G', new = 0 WHERE email LIKE '$EMAIL'"
sql "$CHANGE_PASSWORD_QUERY"

echo "Order Created"
echo "Login with: $EMAIL"