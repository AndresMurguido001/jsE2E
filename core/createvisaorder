#! /usr/local/bin/bash

# Parameters: [email]

get_visa_product_info() {
    QUERY="SELECT 
	CONCAT(countries.name,' ',products.label) as 'Product',
	products.uuid as 'Product UUID',
	options.uuid as 'Option UID',
	jurisdiction.friendly_name as 'Jurisdiction Name'
    from products
    join jurisdiction_mapping on jurisdiction_mapping.product_id = products.id
    join jurisdiction on jurisdiction.id = jurisdiction_mapping.jurisdiction_id
    join jurisdiction_options on jurisdiction_options.jurisdiction_id = jurisdiction_mapping.jurisdiction_id
    join options on options.id = jurisdiction_options.option_id
    join countries ON countries.code = products.country
    WHERE products.type = 'visa'
    GROUP BY jurisdiction_mapping.jurisdiction_id
    ORDER BY RAND()
    LIMIT 1"
    RESULT="$(sql "$QUERY")"
    remove_first_line_from_sql_output "$RESULT"
}

INFO="$(get_visa_product_info)"

PRODUCT="$(cut -f2 <<< "$INFO")"
OPTION="$(cut -f3 <<< "$INFO")"
PRODUCT_NAME="$(cut -f1 <<< "$INFO")"
JURISDICTION_NAME="$(cut -f4 <<< "$INFO")"

ORDER_URL="$API_URL/order/create"

EMAIL=${1:-$(random_email)}

set_name
echo "Create Visa Order: Creating a $(cyan "$PRODUCT_NAME") order on $(yellow "travelvisa") under the email $(purple "$EMAIL") for $(purple "$FIRSTNAME")"

PAYLOAD='{"merchant":"sandbox","source":"'"travelvisa"'","itinerary":{"destinations":[{"country":null,"dates":{"startDate":null,"endDate":null}}],"travelers":{"adults":1,"children":0}},"travelers":[{"info":{"first_name":"'"$FIRSTNAME"'","last_name":"'"$LASTNAME"'","citizenship":null,"residency":null,"date_of_birth":"10/10/1989"},"products":[{"uuid":"'"$PRODUCT"'","option_uuid":"'"$OPTION"'","outbound_speed":"standard_overnight","option_label":"Next Day","product_label":"Passport Renewal","service_type":"next_day_service","cost":399,"addons":[]}]}],"user_profile":{"first_name":"'"$FIRSTNAME"'","last_name":"'"$LASTNAME"'","email":"'"$EMAIL"'","phones":[{"type":"mobile","friendly_name":"Mobile Number","country":"US","value":"9998989990","disabled":true,"required":true,"hint":"We ll use this number to send SMS notifications."},{"type":"landline","friendly_name":"Home or Office Number","country":"US","value":""}],"country":"US","company_name":null,"addresses":[{"type":"billing","address_1":"1301 sw 67th av","address_2":"Apt 4","city":"Miami","state":"FL","country":"US","postal_code":"33144"},{"type":"shipping","address_1":"1301 sw 67th av","address_2":"Apt 4","city":"Miami","state":"FL","country":"US","postal_code":"33144"}]},"gw_tracker":{"referer":"direct","query_string":""},"payment_token":"tok_visa","payment_descriptor":"COMMON.ACCEPT.INAPP.PAYMENT"}'

api_call "$ORDER_URL" "$PAYLOAD"
echo "Create Order: Changing user's password to: password"

set_user_password_to_password "$EMAIL"

echo "Create Order: Order Created, Login with: $(purple "$EMAIL")"